name: Java CI with Gradle (Test)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read         # Needed for reading repository contents
      issues: write          # Allows the action to comment on PRs
      pull_requests: write   # Allows the action to comment on pull requests
      # Ensure the token has write access for PR comments

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Step 3: Grant execute permissions to gradlew
      - name: Grant execute permissions to gradlew
        run: chmod +x gradlew

      # Step 4: Run tests with Gradle
      - name: Run tests
        run: ./gradlew test

      # Step 5: List files for debugging
      - name: List files in the build directory
        run: |
          echo "Listing files in the build directory..."
          ls -R ./build

      # Step 6: Debug PR context (important for checking the availability of PR data)
      - name: Debug PR context
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Pull request title: ${{ github.event.pull_request.title }}"
          echo "Is this a pull request? ${{ github.event_name == 'pull_request' }}"

      # Step 7: Post test results to PR
      - name: Post test results on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = './app/build/reports/tests/test/classes';

            if (!fs.existsSync(path)) {
              console.log("Test results directory not found!");
              return;
            }

            const testResults = [];
            const files = fs.readdirSync(path);

            if (files.length === 0) {
              console.log("No test result files found.");
              return;
            }

            files.forEach(file => {
              const filePath = `${path}/${file}`;
              if (filePath.endsWith('.html')) {
                testResults.push({
                  file: filePath,
                  result: 'HTML report available'
                });
              }
            });

            let comment = "### Test Results\n\n";
            testResults.forEach(result => {
              comment += `- ${result.file}:\n  - Report generated\n\n`;
            });

            if (testResults.length > 0) {
              comment += "✅ **Test reports generated successfully**!";
            } else {
              comment += "⚠️ **No test reports found**.";
            }

            // Ensure PR number is available before commenting
            const prNumber = ${{ github.event.pull_request.number }};
            if (prNumber) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log("No PR number found. Skipping comment creation.");
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@v4
